name: Xcode - Build and Analyze

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build and analyze default scheme using xcodebuild command
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Locate Xcode project/workspace
        id: locate
        run: |
          set -e
          echo "Searching for .xcworkspace or .xcodeproj in the repository (maxdepth 4)..."
          workspace=$(find . -maxdepth 4 -name '*.xcworkspace' -print -quit || true)
          project=$(find . -maxdepth 4 -name '*.xcodeproj' -print -quit || true)
          if [ -n "$workspace" ]; then
            file="$workspace"
            type="workspace"
          elif [ -n "$project" ]; then
            file="$project"
            type="project"
          elif [ -f Package.swift ]; then
            file="Package.swift"
            type="package"
          else
            echo "::error::No Xcode project, workspace, or Swift package found in the repository."
            echo "Repository root listing:"
            ls -la
            exit 1
          fi
          # Normalize path (remove leading ./)
          file=$(echo "$file" | sed 's|^\./||')
          echo "file=$file" >> $GITHUB_OUTPUT
          echo "type=$type" >> $GITHUB_OUTPUT
          echo "Found $type: $file"

      - name: Set default scheme
        id: scheme
        run: |
          set -e
          file="${{ steps.locate.outputs.file }}"
          type="${{ steps.locate.outputs.type }}"
          echo "Using $type: $file"
          list=""
          if [ "$type" = "workspace" ]; then
            list=$(xcodebuild -workspace "$file" -list -json 2>/dev/null || true)
          elif [ "$type" = "project" ]; then
            list=$(xcodebuild -project "$file" -list -json 2>/dev/null || true)
          else
            # For Swift packages, try xcodebuild -list; if empty we'll not attempt JSON parsing.
            list=$(xcodebuild -list -json 2>/dev/null || true)
          fi

          if [ -z "$list" ]; then
            echo "No schemes/targets were returned by xcodebuild -list -json"
            echo "scheme=" >> $GITHUB_OUTPUT
            exit 0
          fi

          scheme=$(echo "$list" | ruby -e "require 'json'; j=JSON.parse(STDIN.read); if j['workspace'] && j['workspace']['schemes'] && j['workspace']['schemes'][0]; puts j['workspace']['schemes'][0]; elsif j['project'] && j['project']['targets'] && j['project']['targets'][0]; puts j['project']['targets'][0]; end")
          scheme="${scheme:-}"
          echo "scheme=$scheme" >> $GITHUB_OUTPUT
          echo "Default scheme: ${scheme:-<none>}"

      - name: Build
        run: |
          set -e
          file="${{ steps.locate.outputs.file }}"
          type="${{ steps.locate.outputs.type }}"
          scheme="${{ steps.scheme.outputs.scheme }}"

          echo "Build inputs -> type: $type, file: $file, scheme: $scheme"

          if [ "$type" = "package" ]; then
            echo "Swift package detected. Running 'swift build' as a fallback."
            swift build
            exit $?
          fi

          if [ -z "$scheme" ]; then
            echo "::error::No scheme was detected. Please ensure your project defines a scheme or set one explicitly in the workflow."
            echo "You can set a scheme by creating a stable shared scheme in Xcode (Product → Scheme → Manage Schemes → check 'Shared')."
            exit 1
          fi

          if [ "$type" = "workspace" ]; then
            file_flag="-workspace"
          else
            file_flag="-project"
          fi

          echo "Running xcodebuild with scheme: $scheme and $file_flag $file"
          xcodebuild clean build analyze -scheme "$scheme" $file_flag "$file" | xcpretty && exit ${PIPESTATUS[0]}
